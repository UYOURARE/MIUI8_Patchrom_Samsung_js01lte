From 3f2b6e5dc053df51492f588c4208d11db7687ccc Mon Sep 17 00:00:00 2001
From: Linh Phi <linhphi9x94@gmail.com>
Date: Mon, 31 Oct 2016 11:35:55 +0700
Subject: [PATCH] update for new miui patchrom

---
 customize_framework.sh                   |   3 +-
 overlay/framework/cmresolver.patch       |  35 ++++++
 overlay/framework/framework_appops.patch | 203 -------------------------------
 overlay/framework/resolver.patch         |  31 +++++
 overlay/services/services_appops.patch   |  32 -----
 5 files changed, 67 insertions(+), 237 deletions(-)
 create mode 100644 overlay/framework/cmresolver.patch
 delete mode 100644 overlay/framework/framework_appops.patch
 create mode 100644 overlay/framework/resolver.patch
 delete mode 100644 overlay/services/services_appops.patch

diff --git a/customize_framework.sh b/customize_framework.sh
index 8ba0b0a..9c7de42 100755
--- a/customize_framework.sh
+++ b/customize_framework.sh
@@ -44,7 +44,6 @@ function applyPatch() {
 
 if [ $2 = "$BUILD_OUT/framework" ]
 then
-	cp ${2/out\//}.jar.out/smali/com/android/internal/app/ResolverActivity*.smali $2/smali/com/android/internal/app/
     applyPatch "overlay/framework"
     rm -rf $2/smali/android/widget/Editor*
     cp -rf $1/smali/android/widget/Editor*.smali $2/smali/android/widget/
@@ -54,6 +53,6 @@ if [ $2 = "$BUILD_OUT/services" ]
 then
     applyPatch "overlay/services"
     rm -rf $2/smali/com/android/server/power/ShutdownThread*
-    cp -rf ../android/services.jar.out/smali/com/android/server/power/ShutdownThread*.smali $2/smali/com/android/server/power/
+    cp -rf $1/smali/com/android/server/power/ShutdownThread*.smali $2/smali/com/android/server/power/
 fi
 
diff --git a/overlay/framework/cmresolver.patch b/overlay/framework/cmresolver.patch
new file mode 100644
index 0000000..a7aeb25
--- /dev/null
+++ b/overlay/framework/cmresolver.patch
@@ -0,0 +1,35 @@
+From 5036092cbec47182901c82494a94b723c3aa7a44 Mon Sep 17 00:00:00 2001
+From: wuxianlin <wuxianlinwxl@gmail.com>
+Date: Sun, 23 Oct 2016 17:53:24 +0800
+Subject: [PATCH] cm ResolverActivity http://review.cyanogenmod.org/#/c/147325/
+
+---
+ .../com/android/internal/app/ResolverActivity$ResolveListAdapter.smali  | 2 +-
+ framework/smali/com/android/internal/app/ResolverActivity.smali         | 2 +-
+ 2 files changed, 2 insertions(+), 2 deletions(-)
+
+--- a/framework/smali/com/android/internal/app/ResolverActivity$ResolveListAdapter.smali
++++ b/framework/smali/com/android/internal/app/ResolverActivity$ResolveListAdapter.smali
+@@ -2081,7 +2081,7 @@
+     return v0
+ .end method
+ 
+-.method public final getView(ILandroid/view/View;Landroid/view/ViewGroup;)Landroid/view/View;
++.method public getView(ILandroid/view/View;Landroid/view/ViewGroup;)Landroid/view/View;
+     .locals 2
+     .param p1, "position"    # I
+     .param p2, "convertView"    # Landroid/view/View;
+--- a/framework/smali/com/android/internal/app/ResolverActivity.smali
++++ b/framework/smali/com/android/internal/app/ResolverActivity.smali
+@@ -35,7 +35,7 @@
+ # instance fields
+ .field private mAdapter:Lcom/android/internal/app/ResolverActivity$ResolveListAdapter;
+ 
+-.field private mAlwaysUseOption:Z
++.field mAlwaysUseOption:Z
+ 
+ .field private mComponentOrders:Ljava/util/List;
+     .annotation system Ldalvik/annotation/Signature;
+-- 
+1.9.1
+
diff --git a/overlay/framework/framework_appops.patch b/overlay/framework/framework_appops.patch
deleted file mode 100644
index d78304d..0000000
--- a/overlay/framework/framework_appops.patch
+++ /dev/null
@@ -1,203 +0,0 @@
-From 6c9889b05ae54ed95497cc27f18386dc2ace9555 Mon Sep 17 00:00:00 2001
-From: wuxianlin <wuxianlinwxl@gmail.com>
-Date: Thu, 29 Sep 2016 11:48:11 +0800
-Subject: [PATCH] framework:fix appops
-
----
- framework/smali/android/app/AppOpsManager.smali | 147 +++++++++++++++++++++++-
- 1 file changed, 145 insertions(+), 2 deletions(-)
-
---- a/framework/smali/android/app/AppOpsManager.smali
-+++ b/framework/smali/android/app/AppOpsManager.smali
-@@ -267,7 +267,7 @@
- 
- .field public static final TAG:Ljava/lang/String; = "AppOps"
- 
--.field public static final _NUM_OP:I = 0x3f
-+.field public static final _NUM_OP:I = 0x45
- 
- .field private static sOpAllowSystemRestrictionBypass:[Z
- 
-@@ -341,7 +341,7 @@
- 
-     const/4 v6, 0x0
- 
--    const/16 v5, 0x3f
-+    const/16 v5, 0x45
- 
-     const/4 v4, 0x0
- 
-@@ -663,6 +663,42 @@
- 
-     aput-object v3, v1, v2
- 
-+    const-string v2, "android:wifi_change"
-+
-+    const/16 v3, 0x3f
-+
-+    aput-object v2, v1, v3
-+
-+    const-string v2, "android:bluetooth_change"
-+
-+    const/16 v3, 0x40
-+
-+    aput-object v2, v1, v3
-+
-+    const-string v2, "android:boot_completed"
-+
-+    const/16 v3, 0x41
-+
-+    aput-object v2, v1, v3
-+
-+    const-string v2, "android:nfc_change"
-+
-+    const/16 v3, 0x42
-+
-+    aput-object v2, v1, v3
-+
-+    const-string v2, "android:data_connect_change"
-+
-+    const/16 v3, 0x43
-+
-+    aput-object v2, v1, v3
-+
-+    const-string v2, "android:su"
-+
-+    const/16 v3, 0x44
-+
-+    aput-object v2, v1, v3
-+
-     sput-object v1, Landroid/app/AppOpsManager;->sOpToString:[Ljava/lang/String;
- 
-     new-array v1, v5, [Ljava/lang/String;
-@@ -1039,6 +1075,42 @@
- 
-     aput-object v3, v1, v2
- 
-+    const-string v2, "WIFI_CHANGE"
-+
-+    const/16 v3, 0x3f
-+
-+    aput-object v2, v1, v3
-+
-+    const-string v2, "BLUETOOTH_CHANGE"
-+
-+    const/16 v3, 0x40
-+
-+    aput-object v2, v1, v3
-+
-+    const-string v2, "BOOT_COMPLETED"
-+
-+    const/16 v3, 0x41
-+
-+    aput-object v2, v1, v3
-+
-+    const-string v2, "NFC_CHANGE"
-+
-+    const/16 v3, 0x42
-+
-+    aput-object v2, v1, v3
-+
-+    const-string v2, "DATA_CONNECT_CHANGE"
-+
-+    const/16 v3, 0x43
-+
-+    aput-object v2, v1, v3
-+
-+    const-string v2, "SU"
-+
-+    const/16 v3, 0x44
-+
-+    aput-object v2, v1, v3
-+
-     sput-object v1, Landroid/app/AppOpsManager;->sOpNames:[Ljava/lang/String;
- 
-     new-array v1, v5, [Ljava/lang/String;
-@@ -1359,6 +1431,38 @@
- 
-     aput-object v3, v1, v2
- 
-+    const-string v2, "android.permission.CHANGE_WIFI_STATE"
-+
-+    const/16 v3, 0x3f
-+
-+    aput-object v2, v1, v3
-+
-+    const/16 v2, 0x40
-+
-+    aput-object v4, v1, v2
-+
-+    const-string v2, "android.permission.RECEIVE_BOOT_COMPLETED"
-+
-+    const/16 v3, 0x41
-+
-+    aput-object v2, v1, v3
-+
-+    const-string v2, "android.permission.NFC"
-+
-+    const/16 v3, 0x42
-+
-+    aput-object v2, v1, v3
-+
-+    const-string v2, "android.permission.MODIFY_PHONE_STATE"
-+
-+    const/16 v3, 0x43
-+
-+    aput-object v2, v1, v3
-+
-+    const/16 v2, 0x44
-+
-+    aput-object v4, v1, v2
-+
-     sput-object v1, Landroid/app/AppOpsManager;->sOpPerms:[Ljava/lang/String;
- 
-     new-array v1, v5, [Ljava/lang/String;
-@@ -1665,6 +1769,32 @@
- 
-     aput-object v4, v1, v2
- 
-+    const/16 v2, 0x3f
-+
-+    aput-object v4, v1, v2
-+
-+    const/16 v2, 0x40
-+
-+    aput-object v4, v1, v2
-+
-+    const/16 v2, 0x41
-+
-+    aput-object v4, v1, v2
-+
-+    const/16 v2, 0x42
-+
-+    aput-object v4, v1, v2
-+
-+    const/16 v2, 0x43
-+
-+    aput-object v4, v1, v2
-+
-+    const-string v2, "no_su"
-+
-+    const/16 v3, 0x44
-+
-+    aput-object v2, v1, v3
-+
-     sput-object v1, Landroid/app/AppOpsManager;->sOpRestrictions:[Ljava/lang/String;
- 
-     new-array v1, v5, [Z
-@@ -2185,6 +2315,12 @@
-         0x3c
-         0x3d
-         0x3e
-+        0x3f
-+        0x40
-+        0x41
-+        0x42
-+        0x43
-+        0x44
-     .end array-data
- 
-     :array_1
--- 
-1.9.1
-
diff --git a/overlay/framework/resolver.patch b/overlay/framework/resolver.patch
new file mode 100644
index 0000000..87e7dfe
--- /dev/null
+++ b/overlay/framework/resolver.patch
@@ -0,0 +1,31 @@
+From b04445f846fc8f0330d585c26c3e57db010c5940 Mon Sep 17 00:00:00 2001
+From: wuxianlin <wuxianlinwxl@gmail.com>
+Date: Sun, 23 Oct 2016 15:58:54 +0800
+Subject: [PATCH] fix ResolverActivity
+
+---
+ .../com/android/internal/app/ResolverActivity$PageGridAdapter.smali    | 3 +++
+ 1 file changed, 3 insertions(+)
+
+--- a/framework/smali/com/android/internal/app/ResolverActivity$PageGridAdapter.smali
++++ b/framework/smali/com/android/internal/app/ResolverActivity$PageGridAdapter.smali
+@@ -228,6 +228,8 @@
+ 
+     check-cast v3, Lcom/android/internal/widget/MaskLayout;
+ 
++    if-eqz v3, :cond_wxl
++
+     iget-object v4, p0, Lcom/android/internal/app/ResolverActivity$PageGridAdapter;->this$0:Lcom/android/internal/app/ResolverActivity;
+ 
+     # getter for: Lcom/android/internal/app/ResolverActivity;->mMaskColor:I
+@@ -237,6 +239,7 @@
+ 
+     invoke-virtual {v3, v4}, Lcom/android/internal/widget/MaskLayout;->setMaskColor(I)V
+ 
++    :cond_wxl
+     new-instance v0, Lcom/android/internal/app/ResolverActivity$ViewHolder;
+ 
+     invoke-direct {v0, v2}, Lcom/android/internal/app/ResolverActivity$ViewHolder;-><init>(Landroid/view/View;)V
+-- 
+1.9.1
+
diff --git a/overlay/services/services_appops.patch b/overlay/services/services_appops.patch
deleted file mode 100644
index 320abf5..0000000
--- a/overlay/services/services_appops.patch
+++ /dev/null
@@ -1,32 +0,0 @@
-From 08f24c4f96168657f7f5a037dd56ec62a61b40dd Mon Sep 17 00:00:00 2001
-From: wuxianlin <wuxianlinwxl@gmail.com>
-Date: Thu, 29 Sep 2016 11:49:34 +0800
-Subject: [PATCH] services:fix appops
-
----
- services/smali/com/android/server/AppOpsService.smali | 4 ++--
- 1 file changed, 2 insertions(+), 2 deletions(-)
-
---- a/services/smali/com/android/server/AppOpsService.smali
-+++ b/services/smali/com/android/server/AppOpsService.smali
-@@ -2348,7 +2348,7 @@
-     .prologue
-     if-ltz p1, :cond_1
- 
--    const/16 v0, 0x3f
-+    const/16 v0, 0x45
- 
-     if-ge p1, v0, :cond_1
- 
-@@ -8549,7 +8549,7 @@
-     .local v1, "opRestrictions":[Z
-     if-nez v1, :cond_0
- 
--    const/16 v3, 0x3f
-+    const/16 v3, 0x45
- 
-     new-array v1, v3, [Z
- 
--- 
-1.9.1
-
